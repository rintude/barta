<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BARTA | Secure Gaming Comms</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html, body { 
            background-color: #050505; color: white; font-family: 'Segoe UI', sans-serif; 
            margin: 0; padding: 0; width: 100%; min-height: 100%; overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }

        /* FIX: Safe Area Padding for Notch/Camera Displays */
        #main-content {
            padding-top: calc(env(safe-area-inset-top) + 1rem);
        }

        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: black; display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 9999;
            transition: opacity 1s ease-out;
        }
        .blinking-logo {
            font-size: 5rem; font-weight: 900; color: #FF0033;
            letter-spacing: -5px; font-style: italic;
            animation: blink 0.8s infinite;
            text-shadow: 0 0 20px rgba(255, 0, 51, 0.7);
        }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.1; } }
        .gaming-border { border: 2px solid #FF0033; clip-path: polygon(5% 0, 100% 0, 100% 90%, 95% 100%, 0 100%, 0 10%); }
        .sharp-panel { background: rgba(20, 20, 20, 0.9); border: 1px solid rgba(255, 0, 51, 0.3); }
        video { width: 100%; border-radius: 4px; background: #111; transform: scaleX(-1); border: 1px solid #333; height: 220px; object-fit: cover; }
        body.loading { overflow: hidden !important; height: 100vh; }
        .file-preview { max-width: 200px; border-radius: 4px; margin-top: 5px; border: 1px solid #444; }
    </style>
</head>
<body class="loading">

    <div id="splash-screen">
        <div class="blinking-logo">BARTA</div>
        <div class="text-[10px] tracking-[0.5em] text-zinc-500 mt-4 uppercase">Initializing Secure Protocol</div>
    </div>

    <div id="main-content" class="max-w-6xl mx-auto p-4 md:p-6 opacity-0 transition-opacity duration-1000">
        <header class="flex justify-between items-center mb-8 border-b-2 border-red-600 pb-4">
            <h1 class="text-3xl md:text-4xl font-black tracking-tighter text-red-600 italic">BARTA</h1>
            <div class="text-right">
                <p class="text-[10px] text-gray-400 uppercase">Status: <span id="status" class="text-yellow-500">Offline</span></p>
                <p id="display-id" class="font-mono text-white text-sm font-bold uppercase tracking-widest">Awaiting ID</p>
            </div>
        </header>

        <div class="grid grid-cols-12 gap-6">
            <div class="col-span-12 md:col-span-4 lg:col-span-3 space-y-4">
                <div class="sharp-panel p-4">
                    <h3 class="text-xs uppercase font-bold text-red-500 mb-3 underline tracking-widest">1. Set My Identity</h3>
                    <input id="my-custom-id" type="text" placeholder="Enter My Code" class="w-full bg-black border border-zinc-800 p-2 mb-2 text-sm text-white uppercase outline-none focus:border-red-600 font-mono">
                    <button id="auth-btn" onclick="initializePeer()" class="w-full bg-white text-black hover:bg-red-600 hover:text-white font-bold py-2 transition uppercase text-xs">Authorize My ID</button>
                </div>
                <div class="sharp-panel p-4">
                    <h3 class="text-xs uppercase font-bold text-red-500 mb-3 underline tracking-widest">2. Link To Friend</h3>
                    <input id="remote-id" type="text" placeholder="Friend's Code" class="w-full bg-black border border-zinc-800 p-2 mb-2 text-sm text-white uppercase outline-none font-mono">
                    <button onclick="startCall()" class="w-full bg-red-600 text-white font-bold py-2 uppercase text-xs mb-2 hover:bg-red-500 transition">Establish Link</button>
                    <button onclick="endCall()" class="w-full border border-red-600 text-red-600 font-bold py-2 uppercase text-xs hover:bg-red-600 hover:text-white transition">Terminate</button>
                </div>
            </div>

            <div class="col-span-12 md:col-span-8 lg:col-span-9">
                <div class="gaming-border p-4 bg-zinc-900/40">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div class="relative">
                            <p id="local-label" class="absolute top-2 left-2 z-10 text-[10px] bg-red-600 px-2 font-bold uppercase font-mono tracking-tighter">LOCAL_FEED</p>
                            <video id="local-video" autoplay muted playsinline></video>
                        </div>
                        <div class="relative">
                            <p id="remote-label" class="absolute top-2 left-2 z-10 text-[10px] bg-zinc-800 px-2 font-bold text-white uppercase font-mono tracking-tighter">REMOTE_FEED</p>
                            <video id="remote-video" autoplay playsinline></video>
                        </div>
                    </div>
                    <div id="chat-box" class="h-48 overflow-y-auto bg-black border border-zinc-800 p-4 mb-4 font-mono text-xs text-green-500 border-l-4 border-l-red-600">
                        <div>> SYSTEM: BOOT COMPLETE.</div>
                    </div>
                    <div class="flex items-center gap-2 bg-black border border-zinc-800 p-2">
                        <label class="cursor-pointer bg-zinc-800 hover:bg-zinc-700 p-2 rounded">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
                            </svg>
                            <input type="file" id="file-input" class="hidden" onchange="sendFile()">
                        </label>
                        <input id="msg-input" type="text" placeholder="Message..." class="flex-1 bg-transparent text-sm text-white outline-none" onkeypress="if(event.key==='Enter') sendMsg()">
                        <button onclick="sendMsg()" class="bg-red-600 px-6 py-2 font-black italic hover:bg-red-500 transition text-sm">SEND</button>
                    </div>
                </div>
            </div>
        </div>
        <footer class="mt-8 text-[10px] text-zinc-600 flex justify-between uppercase border-t border-zinc-900 pt-4 pb-12">
            <span>Barta V8 | Secure Comms</span>
            <span>Created by: Babai</span>
        </footer>
    </div>

    <script>
        window.onload = () => {
            setTimeout(() => {
                document.getElementById('splash-screen').style.display = 'none';
                document.getElementById('main-content').style.opacity = '1';
                document.body.classList.remove('loading');
            }, 2500);
        };

        let peer = null, dataConn = null, localStream = null;
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playSfx(freq, type, duration) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + duration);
        }
        const notifySnd = () => playSfx(880, 'sine', 0.2);
        const connectSnd = () => { playSfx(440, 'square', 0.1); setTimeout(()=>playSfx(660, 'square', 0.1), 100); };

        function log(msg, color = "text-green-500") {
            const chatBox = document.getElementById('chat-box');
            const div = document.createElement('div');
            div.className = color;
            div.innerHTML = `> ${msg}`;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function initializePeer() {
            const btn = document.getElementById('auth-btn');
            const id = document.getElementById('my-custom-id').value.trim().toUpperCase();
            if (!id) return alert("Code Required.");
            btn.innerText = "AUTHORIZING...";
            btn.disabled = true;
            peer = new Peer(id);
            peer.on('open', (confirmedId) => {
                document.getElementById('display-id').innerText = confirmedId;
                document.getElementById('local-label').innerText = confirmedId;
                document.getElementById('status').innerText = "ONLINE";
                document.getElementById('status').className = "text-green-500";
                btn.innerText = "AUTHORIZED";
                connectSnd();
                log("IDENTITY SECURED: " + confirmedId);
            });
            peer.on('connection', conn => {
                dataConn = conn;
                document.getElementById('remote-label').innerText = conn.peer;
                setupDataHandlers();
                connectSnd();
            });
            peer.on('call', call => {
                document.getElementById('remote-label').innerText = call.peer;
                notifySnd();
                navigator.mediaDevices.getUserMedia({video: true, audio: true})
                .then(stream => {
                    localStream = stream;
                    document.getElementById('local-video').srcObject = stream;
                    call.answer(stream);
                    call.on('stream', rs => document.getElementById('remote-video').srcObject = rs);
                }).catch(e => {
                    log("REMOTE STREAM STARTED (No Local Camera)", "text-yellow-500");
                    call.answer();
                    call.on('stream', rs => document.getElementById('remote-video').srcObject = rs);
                });
            });
        }

        function setupDataHandlers() {
            dataConn.on('data', data => {
                if (data.file) handleIncomingFile(data);
                else log(`${dataConn.peer}: ${data}`, "text-red-400");
                notifySnd();
            });
        }

        async function sendFile() {
            const fileInput = document.getElementById('file-input');
            const file = fileInput.files[0];
            if (!file || !dataConn) return;
            const reader = new FileReader();
            reader.onload = () => {
                const fileData = { file: reader.result, fileName: file.name, fileType: file.type };
                dataConn.send(fileData);
                log(`YOU SENT: ${file.name}`, "text-white");
                displayFilePreview(fileData, "YOU");
            };
            reader.readAsDataURL(file);
        }

        function handleIncomingFile(data) {
            log(`${dataConn.peer} SHARED MEDIA`, "text-blue-400");
            displayFilePreview(data, dataConn.peer);
        }

        function displayFilePreview(data, sender) {
            const chatBox = document.getElementById('chat-box');
            const container = document.createElement('div');
            container.className = "my-2 p-2 border border-zinc-800 bg-zinc-900 rounded";
            let preview = "";
            if (data.fileType.startsWith('image/')) preview = `<img src="${data.file}" class="file-preview">`;
            else if (data.fileType.startsWith('audio/')) preview = `<audio controls src="${data.file}" class="mt-2 w-full"></audio>`;
            else if (data.fileType.startsWith('video/')) preview = `<video controls src="${data.file}" class="file-preview mt-2"></video>`;
            container.innerHTML = `<div class="text-[10px] text-zinc-500 uppercase font-bold">${sender} MEDIA</div>${preview}<div class="mt-2"><a href="${data.file}" download="${data.fileName}" class="text-xs bg-red-600 px-3 py-1 rounded font-bold text-white">DOWNLOAD</a></div>`;
            chatBox.appendChild(container);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function startCall() {
            const rid = document.getElementById('remote-id').value.trim().toUpperCase();
            if (!rid) return;
            document.getElementById('remote-label').innerText = rid;
            dataConn = peer.connect(rid);
            setupDataHandlers();
            try {
                localStream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
                document.getElementById('local-video').srcObject = localStream;
                const call = peer.call(rid, localStream);
                call.on('stream', rs => { document.getElementById('remote-video').srcObject = rs; connectSnd(); });
            } catch (err) { 
                log("CALLING WITHOUT CAMERA", "text-yellow-500");
                const call = peer.call(rid, new MediaStream());
                call.on('stream', rs => { document.getElementById('remote-video').srcObject = rs; connectSnd(); });
            }
        }

        function sendMsg() {
            const input = document.getElementById('msg-input');
            if (input.value && dataConn && dataConn.open) {
                dataConn.send(input.value);
                log("YOU: " + input.value, "text-white");
                input.value = '';
            }
        }

        function endCall() {
            if (localStream) localStream.getTracks().forEach(t => t.stop());
            document.getElementById('local-video').srcObject = null;
            document.getElementById('remote-video').srcObject = null;
            log("DISCONNECTED.");
        }
    </script>
</body>
</html>
